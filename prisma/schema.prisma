generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String? @unique
  password String? // nullable for Google OAuth users
  phone    String? // user's phone number
  image    String?

  accounts Account[]
  sessions Session[]

  // ðŸ”¥ REQUIRED RELATION (you were missing this)
  bookings Booking[]
  
  // Password reset tokens
  resetTokens PasswordResetToken[]

  role      String   @default("user") // "user" or "admin"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?

  user User @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id])
}

model Booking {
  id     String @id @default(cuid())
  userId String

  // Legacy fields (will be deprecated after migration)
  pickup String
  drop   String
  
  // NEW: Structured location data for pickup
  pickupAddress     String?
  pickupPlaceId     String?
  pickupLat         Float?
  pickupLng         Float?
  
  // NEW: Structured location data for drop-off
  dropAddress       String?
  dropPlaceId       String?
  dropLat           Float?
  dropLng           Float?
  
  date   DateTime
  car    String
  notes  String?

  status     String  @default("Pending") // Pending, Approved, InProgress, AwaitingFinalPayment, Completed, Cancelled
  payment50  Boolean @default(false)
  payment100 Boolean @default(false)

  totalPrice            Float?
  depositAmount         Float?
  stripeSessionId       String? @unique
  stripePaymentIntentId String?

  finalPaymentUrl String?
  completedAt     DateTime?

  // NEW: Booking type to differentiate services
  bookingType BookingType @default(AIRPORT_TRANSFER)

  // NEW: Wedding-specific fields
  eventStartTime  DateTime?
  eventEndTime    DateTime?
  basePrice       Float? // For wedding: $850
  hourlyRate      Float? // SUV: $163/hr, Van: $213/hr
  additionalHours Int?      @default(0)
  
  // NEW: Distance-based pricing data
  calculatedDistance  Float? // Actual distance in km from Distance Matrix API
  estimatedDuration   Int?   // Drive time in seconds
  pricingMethod      String? // "DISTANCE_BASED" | "ROUTE_BASED" | "MANUAL"
  priceTierBreakdown String? // JSON string of tier breakdown for transparency
  passengerCount Int?    @default(1) // Number of passengers


  // NEW: Airport-specific fields
  route        String? // "YYC-Canmore", "YYC-Banff"
  luggageCount Int?    @default(0) // Number of luggage items


  // Relations
  user   User           @relation(fields: [userId], references: [id])
  addOns BookingAddOn[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([userId])
  @@index([bookingType])
  @@index([status])
}

// NEW: Booking Type Enum
enum BookingType {
  AIRPORT_TRANSFER
  WEDDING_SHUTTLE
  CEREMONY_PICKUP
  CUSTOM
}

// NEW: Add-On Services Model
model BookingAddOn {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  addOnType      AddOnType
  serviceName    String
  price          Float
  duration       Int? // hours
  pickupLocation String?
  dropLocation   String?
  notes          String?

  createdAt DateTime @default(now())

  @@index([bookingId])
}

// NEW: Add-On Type Enum
enum AddOnType {
  CEREMONY_PICKUP_DROPOFF
  EXTRA_STOP
  EXTENDED_HOURS
  CUSTOM
}

// Password Reset Token Model
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique  // Hashed token for security
  expires   DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expires])
}
