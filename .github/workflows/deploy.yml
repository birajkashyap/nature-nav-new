name: Deploy to Production

on:
  # Disabled auto-deployment since project transferred to client
  # Keep workflow for portfolio/interview demonstration
  # push:
  #   branches: [main]
  workflow_dispatch:  # Manual trigger only

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  deploy-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://www.naturenavigator.ca
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel Production
        id: deploy
        run: |
          deployment_url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$deployment_url" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deployment Summary
        run: |
          echo "### üöÄ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-vercel
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Migration Summary
        run: |
          echo "### üìä Database Migrations Complete" >> $GITHUB_STEP_SUMMARY

  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-vercel, run-migrations]
    
    steps:
      - name: Wait for deployment to be ready
        run: sleep 30

      - name: Check deployment health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://www.naturenavigator.ca/api/health)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Health check passed!"
            echo "### ‚úÖ Health Check Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Health check failed with status: $response"
            echo "### ‚ùå Health Check Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Verify critical endpoints
        run: |
          endpoints=(
            "https://www.naturenavigator.ca"
            "https://www.naturenavigator.ca/api/health"
            "https://www.naturenavigator.ca/login"
          )
          
          for endpoint in "${endpoints[@]}"; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "$endpoint")
            if [ $status -eq 200 ] || [ $status -eq 404 ]; then
              echo "‚úÖ $endpoint: $status"
            else
              echo "‚ùå $endpoint: $status"
              exit 1
            fi
          done

  notify-slack:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-vercel, health-check]
    if: always()
    
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        if: env.SLACK_WEBHOOK_URL != ''
        with:
          payload: |
            {
              "text": "Production Deployment ${{ needs.health-check.result == 'success' && '‚úÖ Successful' || '‚ùå Failed' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment*\n${{ needs.health-check.result == 'success' && '‚úÖ Successful' || '‚ùå Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*URL:*\nhttps://www.naturenavigator.ca"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
